<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Savings/Investment Account Simulator</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<style>
  :root {
    --uk: #1e40af;
    --ca: #dc2626;
    --se: #f59e0b;
    --eu: #059669;
    --tax: #6b7280;
    --bg: #f8fafc;
    --card: #ffffff;
    --border: #e2e8f0;
    --text: #1e293b;
    --muted: #64748b;
    --warn: #b45309;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg); color: var(--text); line-height: 1.5;
    padding: 1.5rem; max-width: 1440px; margin: 0 auto;
  }
  h1 { font-size: 1.6rem; margin-bottom: 0.25rem; }
  .subtitle { color: var(--muted); margin-bottom: 1rem; font-size: 0.95rem; }
  .grid { display: grid; gap: 1.5rem; }
  .grid-2 { grid-template-columns: 380px 1fr; }
  .card {
    background: var(--card); border: 1px solid var(--border);
    border-radius: 10px; padding: 1.25rem;
  }
  .card h2 { font-size: 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
  .card h3 { font-size: 0.9rem; margin-bottom: 0.5rem; margin-top: 1.25rem; }
  .card h3:first-of-type { margin-top: 0.5rem; }
  label { display: block; font-size: 0.82rem; color: var(--muted); margin-bottom: 0.2rem; margin-top: 0.7rem; }
  label:first-child { margin-top: 0; }
  input[type=range] { width: 100%; cursor: pointer; }
  .val { font-weight: 600; font-size: 0.95rem; float: right; color: var(--text); }
  .section-title { font-size: 0.85rem; font-weight: 700; color: var(--text); margin-top: 1rem; margin-bottom: 0.1rem; text-transform: uppercase; letter-spacing: 0.03em; }
  .charts-area { display: flex; flex-direction: column; gap: 1.5rem; }
  .chart-box { position: relative; width: 100%; }
  .chart-box canvas { width: 100% !important; }

  .summary-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; margin-top: 0.5rem; }
  .summary-table th, .summary-table td { padding: 0.4rem 0.5rem; text-align: right; border-bottom: 1px solid var(--border); white-space: nowrap; }
  .summary-table th:first-child, .summary-table td:first-child { text-align: left; white-space: normal; }
  .summary-table th { font-weight: 600; color: var(--muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.03em; }
  .table-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
  .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; vertical-align: middle; }
  .dot-uk { background: var(--uk); } .dot-ca { background: var(--ca); }
  .dot-se { background: var(--se); } .dot-eu { background: var(--eu); }
  .dot-tax { background: var(--tax); }

  .tabs { display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap; }
  .tab {
    padding: 0.35rem 0.9rem; border-radius: 6px; border: 1px solid var(--border);
    background: var(--card); cursor: pointer; font-size: 0.82rem; color: var(--muted);
    transition: all 0.15s;
  }
  .tab.active { background: var(--text); color: white; border-color: var(--text); }

  .note { font-size: 0.78rem; color: var(--muted); margin-top: 0.75rem; line-height: 1.4; }
  .note strong { color: var(--text); }

  .model-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 0.75rem; margin-bottom: 1.5rem; }
  .model-card { padding: 0.75rem; border-radius: 8px; font-size: 0.8rem; border-left: 4px solid; }
  .model-card h3 { font-size: 0.85rem; margin-bottom: 0.25rem; margin-top: 0; }
  .model-card.uk { border-color: var(--uk); background: #eff6ff; }
  .model-card.ca { border-color: var(--ca); background: #fef2f2; }
  .model-card.se { border-color: var(--se); background: #fffbeb; }
  .model-card.eu { border-color: var(--eu); background: #ecfdf5; }

  .disclaimer {
    background: #fffbeb; border: 1px solid #f59e0b; border-radius: 8px;
    padding: 0.5rem 0.8rem; font-size: 0.78rem; color: var(--warn); margin-bottom: 0.4rem;
  }
  .disclaimer strong { color: #92400e; }

  .warning-banner {
    background: #fef2f2; border: 1px solid #dc2626; border-radius: 6px;
    padding: 0.4rem 0.7rem; font-size: 0.78rem; color: #dc2626;
    margin-top: 0.3rem; display: none;
  }
  .warning-banner.visible { display: block; }

  .toggle-row { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.7rem; }
  .toggle-row label { margin: 0; }
  .toggle { position: relative; width: 40px; height: 22px; flex-shrink: 0; }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle .slider {
    position: absolute; cursor: pointer; inset: 0;
    background: #cbd5e1; border-radius: 22px; transition: 0.2s;
  }
  .toggle .slider::before {
    content: ''; position: absolute; height: 16px; width: 16px;
    left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.2s;
  }
  .toggle input:checked + .slider { background: var(--uk); }
  .toggle input:checked + .slider::before { transform: translateX(18px); }

  .currency-note {
    font-size: 0.72rem; color: var(--muted); font-style: italic;
    margin-top: 0.2rem; line-height: 1.3;
  }

  .presets { display: flex; gap: 0.4rem; flex-wrap: wrap; margin-bottom: 0.75rem; }
  .preset-btn {
    padding: 0.3rem 0.7rem; border-radius: 6px; border: 1px solid var(--border);
    background: var(--card); cursor: pointer; font-size: 0.78rem; color: var(--muted);
    transition: all 0.15s;
  }
  .preset-btn:hover { background: #f1f5f9; color: var(--text); }

  .radio-row { display: flex; gap: 1rem; margin-top: 0.3rem; }
  .radio-row label { display: flex; align-items: center; gap: 0.3rem; cursor: pointer; font-size: 0.82rem; color: var(--text); margin: 0; }
  .radio-row input { cursor: pointer; }

  .share-row { display: flex; gap: 0.5rem; margin-top: 0.5rem; align-items: center; }
  .share-btn {
    padding: 0.3rem 0.8rem; border-radius: 6px; border: 1px solid var(--border);
    background: var(--card); cursor: pointer; font-size: 0.78rem; color: var(--muted);
    transition: all 0.15s;
  }
  .share-btn:hover { background: #f1f5f9; color: var(--text); }
  .share-msg { font-size: 0.75rem; color: #059669; opacity: 0; transition: opacity 0.3s; }
  .share-msg.show { opacity: 1; }

  @media (max-width: 900px) {
    .grid-2 { grid-template-columns: 1fr; }
    body { padding: 0.75rem; }
  }
</style>
</head>
<body>

<h1>Lifetime Savings/Investment Account Simulator</h1>
<p class="subtitle">Compare UK ISA, Canada TFSA, Sweden ISK, and EU proposed models against a standard taxable account</p>

<div class="model-cards">
  <div class="model-card uk">
    <h3>UK ISA</h3>
    Fixed annual allowance, fully tax-free growth. No carry-forward of unused room. Flexible withdrawals.
  </div>
  <div class="model-card ca">
    <h3>Canada TFSA</h3>
    Annual room accumulates &amp; carries forward. Withdrawals restore room the following year. Tax-free inside wrapper.
  </div>
  <div class="model-card se">
    <h3>Sweden ISK</h3>
    No contribution limit. Annual notional tax on average account value (govt rate + spread). No capital gains tracking.
  </div>
  <div class="model-card eu">
    <div class="disclaimer"><strong>Illustrative only.</strong> No harmonised EU tax treatment exists. Parameters below are invented to explore a partial-exemption design space. Do not cite as an actual proposal.</div>
    <h3>EU Proposed</h3>
    Cross-border portable wrapper. Modelled here as partial exemption with a modest annual allowance.
  </div>
</div>

<div class="grid grid-2">
  <!-- Controls -->
  <div>
    <div class="card">
      <h2>Investor Profile</h2>
      <div class="presets">
        <span style="font-size:0.78rem; color:var(--muted); align-self:center; margin-right:0.2rem;">Presets:</span>
        <button class="preset-btn" data-preset="young-low">Young, low earner</button>
        <button class="preset-btn" data-preset="mid-median">Mid-career, median</button>
        <button class="preset-btn" data-preset="high-earner">High earner</button>
        <button class="preset-btn" data-preset="lifetime">Birth-to-retirement</button>
      </div>

      <label>Annual Contribution <span class="val" id="v_contrib">€6,000</span></label>
      <input type="range" id="contrib" min="500" max="50000" step="500" value="6000">

      <label>Contribution Growth Rate <span class="val" id="v_contribGrowth">0.0%</span></label>
      <input type="range" id="contribGrowth" min="0" max="5" step="0.5" value="0">
      <p class="currency-note">Annual increase in contributions (e.g. wage growth). 0% = flat.</p>

      <label>Investment Horizon <span class="val" id="v_horizon">30 years</span></label>
      <input type="range" id="horizon" min="1" max="70" step="1" value="30">

      <label>Starting Age <span class="val" id="v_startAge">25</span></label>
      <input type="range" id="startAge" min="0" max="65" step="1" value="25">

      <label>Nominal Annual Return <span class="val" id="v_return">6.0%</span></label>
      <input type="range" id="annualReturn" min="0" max="15" step="0.5" value="6">

      <label>Dividend Yield (within return) <span class="val" id="v_divYield">2.0%</span></label>
      <input type="range" id="divYield" min="0" max="6" step="0.25" value="2">
      <div class="warning-banner" id="divWarn">Dividend yield exceeds total return — capital growth will be negative.</div>

      <label>Annual Management Fee <span class="val" id="v_fee">0.75%</span></label>
      <input type="range" id="fee" min="0" max="3" step="0.05" value="0.75">

      <label>Inflation Rate <span class="val" id="v_inflation">2.5%</span></label>
      <input type="range" id="inflation" min="0" max="8" step="0.25" value="2.5">

      <div class="toggle-row">
        <label class="toggle"><input type="checkbox" id="realTerms"><span class="slider"></span></label>
        <label style="font-weight:600; color:var(--text); cursor:pointer;" for="realTerms">Show in real (inflation-adjusted) terms</label>
      </div>

      <div class="section-title">Tax Environment (Irish defaults)</div>

      <label style="font-weight:600; color:var(--text); margin-bottom:0.1rem;">Taxable baseline account type</label>
      <div class="radio-row">
        <label><input type="radio" name="taxMode" value="fund" checked> Fund wrapper (exit tax)</label>
        <label><input type="radio" name="taxMode" value="equity"> Direct equities (CGT)</label>
      </div>
      <p class="currency-note">Fund wrapper: 41% exit tax + deemed disposal. Direct equities: income tax on dividends, CGT on gains, annual exemption.</p>

      <div id="fundTaxControls">
        <label>Exit Tax / Deemed Disposal Rate <span class="val" id="v_exitTax">41%</span></label>
        <input type="range" id="exitTax" min="0" max="50" step="1" value="41">

        <label>Deemed Disposal Period <span class="val" id="v_deemedYrs">8 years</span></label>
        <input type="range" id="deemedYrs" min="1" max="15" step="1" value="8">
      </div>

      <div id="equityTaxControls" style="display:none;">
        <label>Marginal Income Tax + USC + PRSI <span class="val" id="v_incTax">52%</span></label>
        <input type="range" id="incTax" min="0" max="60" step="1" value="52">
        <p class="currency-note">Applied to dividend income.</p>

        <label>Capital Gains Tax Rate <span class="val" id="v_cgt">33%</span></label>
        <input type="range" id="cgt" min="0" max="50" step="1" value="33">

        <label>Annual CGT Exemption <span class="val" id="v_cgtExempt">€1,270</span></label>
        <input type="range" id="cgtExempt" min="0" max="5000" step="10" value="1270">
      </div>

      <div class="section-title">Account Parameters</div>

      <label>UK ISA Annual Allowance <span class="val" id="v_isaAllow">€20,000</span></label>
      <input type="range" id="isaAllow" min="1000" max="50000" step="1000" value="20000">

      <label>Canada TFSA Annual Room <span class="val" id="v_tfsaRoom">€7,000</span></label>
      <input type="range" id="tfsaRoom" min="1000" max="20000" step="500" value="7000">

      <label>Sweden ISK Notional Rate (govt rate + spread) <span class="val" id="v_iskRate">3.5%</span></label>
      <input type="range" id="iskRate" min="0.5" max="8" step="0.25" value="3.5">

      <label>ISK Tax Rate on Notional Base <span class="val" id="v_iskTaxRate">30%</span></label>
      <input type="range" id="iskTaxRate" min="10" max="50" step="1" value="30">

      <label>EU Proposed Annual Allowance <span class="val" id="v_euAllow">€10,000</span></label>
      <input type="range" id="euAllow" min="1000" max="50000" step="1000" value="10000">

      <label>EU Gains Exemption % <span class="val" id="v_euExempt">50%</span></label>
      <input type="range" id="euExempt" min="0" max="100" step="5" value="50">

      <div class="section-title">Fiscal / Population Scaling</div>

      <label>Participating Accounts <span class="val" id="v_popAccounts">1,000,000</span></label>
      <input type="range" id="popAccounts" min="100000" max="3500000" step="50000" value="1000000">
      <p class="currency-note">Number of active accounts. Ireland: ~3.8m adults, ~5.1m residents.</p>

      <label>State Borrowing Rate (for NPV) <span class="val" id="v_stateRate">3.0%</span></label>
      <input type="range" id="stateRate" min="0.5" max="6" step="0.25" value="3">

      <label>Nominal GDP Growth (for revenue scaling) <span class="val" id="v_gdpGrowth">4.5%</span></label>
      <input type="range" id="gdpGrowth" min="1" max="8" step="0.5" value="4.5">
      <p class="currency-note">Used to project revenue benchmarks forward. Comparison anchors grow at this rate.</p>

      <label>Retirement Age <span class="val" id="v_retireAge">66</span></label>
      <input type="range" id="retireAge" min="60" max="70" step="1" value="66">

      <label>Pension Offset Rate <span class="val" id="v_pensionOffset">0%</span></label>
      <input type="range" id="pensionOffset" min="0" max="30" step="1" value="0">
      <p class="currency-note">Assumed % reduction in state pension cost per account, scaled by net wealth relative to taxable baseline. 0% = conservative.</p>

      <label>Annual State Pension Cost per Person <span class="val" id="v_pensionCost">€14,400</span></label>
      <input type="range" id="pensionCost" min="5000" max="25000" step="200" value="14400">

      <label>Pension Draw Years <span class="val" id="v_pensionYears">20</span></label>
      <input type="range" id="pensionYears" min="5" max="35" step="1" value="20">

      <div class="section-title">Withdrawal Modelling</div>
      <label>Withdrawal per Year <span class="val" id="v_withdraw">€0</span></label>
      <input type="range" id="withdraw" min="0" max="30000" step="500" value="0">

      <label>Withdrawals Begin in Year <span class="val" id="v_withdrawStart">15</span></label>
      <input type="range" id="withdrawStart" min="1" max="60" step="1" value="15">
      <p class="currency-note">TFSA: withdrawals restore room next year. ISA: flexible (no allowance impact). Taxable/EU: withdrawal triggers tax on embedded gain.</p>

      <p class="currency-note" style="margin-top:1rem;">All values normalised to EUR. Real allowances: UK ISA = £20k, Canada TFSA = C$7k. Swedish ISK has no contribution limit.</p>

      <div class="share-row">
        <button class="share-btn" id="shareBtn">Copy link to this configuration</button>
        <span class="share-msg" id="shareMsg">Copied!</span>
      </div>
    </div>
  </div>

  <!-- Charts & Results -->
  <div class="charts-area">
    <div class="card">
      <div class="tabs">
        <div class="tab active" data-chart="wealth">Net Wealth</div>
        <div class="tab" data-chart="tax">Cumulative Tax</div>
        <div class="tab" data-chart="annual">Annual Tax Cost</div>
        <div class="tab" data-chart="contrib">Contributions In</div>
      </div>
      <div class="chart-box">
        <canvas id="mainChart" height="320"></canvas>
      </div>
      <p class="note" id="chartNote"></p>
    </div>

    <div class="card">
      <h2 id="summaryTitle">Summary at End of Horizon</h2>
      <div class="table-scroll">
      <table class="summary-table" id="summaryTable">
        <thead>
          <tr>
            <th>Account</th>
            <th>Contributions</th>
            <th>Gross Value</th>
            <th>Total Tax</th>
            <th>Net Value</th>
            <th>Eff. Tax Rate</th>
            <th>vs Taxable</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
    </div>

    <div class="card">
      <h2>Fiscal Cost to Exchequer</h2>

      <h3>Per Investor</h3>
      <div class="table-scroll">
      <table class="summary-table" id="fiscalTable">
        <thead>
          <tr>
            <th>Account</th>
            <th>Tax Foregone</th>
            <th>NPV of Foregone</th>
            <th>As % of Gross</th>
            <th>Annualised</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>

      <h3>Aggregate National Cost</h3>
      <p class="note" style="margin-top:0; margin-bottom:0.5rem;">Scaled to <strong id="popLabel">1,000,000</strong> accounts. <strong>Mature-scheme estimate</strong> — assumes all accounts have run for the full horizon. Year-1 cost of a new scheme would be far lower; see year-1 row below.</p>
      <div class="table-scroll">
      <table class="summary-table" id="aggFiscalTable">
        <thead>
          <tr>
            <th>Account</th>
            <th>NPV Foregone</th>
            <th>Annual Avg</th>
            <th>Year-1 Cost</th>
            <th>Final-Year Cost</th>
            <th>Pension Offset</th>
            <th>Net Fiscal Cost</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>

      <h3>Comparison Anchors</h3>
      <p class="note" style="margin-top:0; margin-bottom:0.5rem;">Annual aggregate cost vs projected Irish revenue benchmarks. Year-1 cost shown against 2024 benchmarks; final-year cost against projected benchmarks grown at nominal GDP rate.</p>
      <div class="table-scroll">
      <table class="summary-table" id="anchorTable">
        <thead>
          <tr>
            <th>Account</th>
            <th>Year</th>
            <th>Annual Cost</th>
            <th>% of CGT</th>
            <th>% of Income Tax</th>
            <th>% of Total Tax</th>
            <th>% of SPC Spend</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      </div>
      <p class="note">CGT = Capital Gains Tax receipts (€2.2bn 2024). SPC = Social Protection contributory pensions (€9.5bn 2024). Revenue benchmarks are approximate and grown at the nominal GDP rate you set.</p>
    </div>

    <div class="card">
      <h2>Design Trade-offs</h2>
      <div id="tradeoffs" style="font-size:0.85rem; line-height:1.55;"></div>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
const fmt = n => '€' + Math.round(n).toLocaleString('en-IE');
const pct = n => (n * 100).toFixed(1) + '%';
const fmtBn = n => {
  const abs = Math.abs(n);
  const sign = n < 0 ? '-' : '';
  if (abs >= 1e9) return sign + '€' + (abs / 1e9).toFixed(2) + 'bn';
  if (abs >= 1e6) return sign + '€' + (abs / 1e6).toFixed(1) + 'm';
  if (abs >= 1e3) return sign + '€' + (abs / 1e3).toFixed(0) + 'k';
  return fmt(n);
};

// --- Slider bindings ---
const sliders = [
  ['contrib', 'v_contrib', v => `€${Number(v).toLocaleString()}`],
  ['contribGrowth', 'v_contribGrowth', v => `${v}%`],
  ['horizon', 'v_horizon', v => `${v} years`],
  ['startAge', 'v_startAge', v => v],
  ['annualReturn', 'v_return', v => `${v}%`],
  ['divYield', 'v_divYield', v => `${v}%`],
  ['fee', 'v_fee', v => `${v}%`],
  ['inflation', 'v_inflation', v => `${v}%`],
  ['incTax', 'v_incTax', v => `${v}%`],
  ['cgt', 'v_cgt', v => `${v}%`],
  ['cgtExempt', 'v_cgtExempt', v => `€${Number(v).toLocaleString()}`],
  ['exitTax', 'v_exitTax', v => `${v}%`],
  ['deemedYrs', 'v_deemedYrs', v => `${v} years`],
  ['isaAllow', 'v_isaAllow', v => `€${Number(v).toLocaleString()}`],
  ['tfsaRoom', 'v_tfsaRoom', v => `€${Number(v).toLocaleString()}`],
  ['iskRate', 'v_iskRate', v => `${v}%`],
  ['iskTaxRate', 'v_iskTaxRate', v => `${v}%`],
  ['euAllow', 'v_euAllow', v => `€${Number(v).toLocaleString()}`],
  ['euExempt', 'v_euExempt', v => `${v}%`],
  ['withdraw', 'v_withdraw', v => `€${Number(v).toLocaleString()}`],
  ['withdrawStart', 'v_withdrawStart', v => v],
  ['popAccounts', 'v_popAccounts', v => Number(v).toLocaleString()],
  ['stateRate', 'v_stateRate', v => `${v}%`],
  ['gdpGrowth', 'v_gdpGrowth', v => `${v}%`],
  ['retireAge', 'v_retireAge', v => v],
  ['pensionOffset', 'v_pensionOffset', v => `${v}%`],
  ['pensionCost', 'v_pensionCost', v => `€${Number(v).toLocaleString()}`],
  ['pensionYears', 'v_pensionYears', v => v],
];

sliders.forEach(([id, vid, formatter]) => {
  const el = $(id);
  $(vid).textContent = formatter(el.value);
  el.addEventListener('input', () => { $(vid).textContent = formatter(el.value); runSim(); });
});

$('realTerms').addEventListener('change', runSim);

// Tax mode toggle
document.querySelectorAll('input[name="taxMode"]').forEach(r => {
  r.addEventListener('change', () => {
    const isFund = document.querySelector('input[name="taxMode"]:checked').value === 'fund';
    $('fundTaxControls').style.display = isFund ? '' : 'none';
    $('equityTaxControls').style.display = isFund ? 'none' : '';
    runSim();
  });
});

// Presets
const presets = {
  'young-low': { contrib: 2000, contribGrowth: 2, horizon: 40, startAge: 22, annualReturn: 6, divYield: 2, fee: 0.75 },
  'mid-median': { contrib: 6000, contribGrowth: 1, horizon: 25, startAge: 40, annualReturn: 6, divYield: 2, fee: 0.75 },
  'high-earner': { contrib: 20000, contribGrowth: 0, horizon: 20, startAge: 45, annualReturn: 6, divYield: 2, fee: 0.5 },
  'lifetime': { contrib: 3000, contribGrowth: 2.5, horizon: 66, startAge: 0, annualReturn: 6, divYield: 2, fee: 0.75 },
};
document.querySelectorAll('.preset-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const p = presets[btn.dataset.preset];
    if (!p) return;
    Object.entries(p).forEach(([k, v]) => {
      const el = $(k);
      if (el) { el.value = v; el.dispatchEvent(new Event('input')); }
    });
  });
});

// Share URL
$('shareBtn').addEventListener('click', () => {
  const params = {};
  sliders.forEach(([id]) => { params[id] = $(id).value; });
  params.taxMode = document.querySelector('input[name="taxMode"]:checked').value;
  params.realTerms = $('realTerms').checked ? '1' : '0';
  const hash = '#' + new URLSearchParams(params).toString();
  const url = location.origin + location.pathname + hash;
  navigator.clipboard.writeText(url).then(() => {
    $('shareMsg').classList.add('show');
    setTimeout(() => $('shareMsg').classList.remove('show'), 2000);
  });
});

// Load from URL hash
function loadFromHash() {
  if (!location.hash || location.hash.length < 2) return;
  try {
    const params = new URLSearchParams(location.hash.slice(1));
    params.forEach((v, k) => {
      if (k === 'taxMode') {
        const radio = document.querySelector(`input[name="taxMode"][value="${v}"]`);
        if (radio) { radio.checked = true; radio.dispatchEvent(new Event('change')); }
      } else if (k === 'realTerms') {
        $('realTerms').checked = v === '1';
      } else {
        const el = $(k);
        if (el && el.type === 'range') { el.value = v; el.dispatchEvent(new Event('input')); }
      }
    });
  } catch (e) { /* ignore bad hash */ }
}

// Chart tabs
let activeChart = 'wealth';
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    activeChart = t.dataset.chart;
    renderChart();
  });
});

let chart = null;
let simData = null;

function val(id) { return parseFloat($(id).value); }
function getTaxMode() { return document.querySelector('input[name="taxMode"]:checked').value; }

function runSim() {
  const baseContrib = val('contrib');
  const contribGrowthRate = val('contribGrowth') / 100;
  const horizon = val('horizon');
  const nominalReturn = val('annualReturn') / 100;
  const rawDivY = val('divYield') / 100;
  const divY = Math.min(rawDivY, nominalReturn);
  const fee = val('fee') / 100;
  const inflationRate = val('inflation') / 100;
  const showReal = $('realTerms').checked;
  const taxMode = getTaxMode();

  // Tax rates
  const exitTax = val('exitTax') / 100;
  const deemedYrs = val('deemedYrs');
  const incTax = val('incTax') / 100;
  const cgtRate = val('cgt') / 100;
  const cgtExempt = val('cgtExempt');

  const isaAllow = val('isaAllow');
  const tfsaAnnualRoom = val('tfsaRoom');
  const iskNotional = val('iskRate') / 100;
  const iskTaxRate = val('iskTaxRate') / 100;
  const euAllow = val('euAllow');
  const euExempt = val('euExempt') / 100;
  const withdrawAmt = val('withdraw');
  const withdrawStart = val('withdrawStart');

  // Net return after fees — fee is proportional AUM drag, reduces both components proportionally
  const r = nominalReturn - fee;
  const feeRatio = nominalReturn > 0 ? r / nominalReturn : 1;
  const netDivY = divY * feeRatio;
  const netCapGrowth = r - netDivY;

  // Dividend yield warning
  $('divWarn').classList.toggle('visible', rawDivY > nominalReturn);

  // ===== TAXABLE =====
  let taxBal = 0, taxCumTax = 0, taxCostBasis = 0, taxTotalContrib = 0;
  let taxBalArr = [], taxCumTaxArr = [], taxAnnTaxArr = [], taxContribArr = [];

  // ===== UK ISA =====
  let isaBal = 0, isaTotalContrib = 0;
  let isaBalArr = [], isaCumTaxArr = [], isaAnnTaxArr = [], isaContribArr = [];

  // ===== Canada TFSA =====
  let tfsaBal = 0, tfsaUnusedRoom = 0, tfsaTotalContrib = 0, tfsaRestoredRoom = 0;
  let tfsaBalArr = [], tfsaCumTaxArr = [], tfsaAnnTaxArr = [], tfsaContribArr = [];

  // ===== Sweden ISK =====
  let iskBal = 0, iskCumTax = 0, iskTotalContrib = 0;
  let iskBalArr = [], iskCumTaxArr = [], iskAnnTaxArr = [], iskContribArr = [];

  // ===== EU Proposed =====
  let euBal = 0, euCumTax = 0, euCostBasis = 0, euTotalContrib = 0;
  let euBalArr = [], euCumTaxArr = [], euAnnTaxArr = [], euContribArr = [];

  // Gross counterfactuals (no-tax paths)
  let taxGross = 0, isaGross = 0, tfsaGross = 0, iskGross = 0, euGross = 0;

  for (let y = 1; y <= horizon; y++) {
    const yearContrib = baseContrib * Math.pow(1 + contribGrowthRate, y - 1);
    const doWithdraw = y >= withdrawStart;
    const wAmt = doWithdraw ? withdrawAmt : 0;

    // ========== TAXABLE ==========
    taxBal += yearContrib;
    taxCostBasis += yearContrib;
    taxTotalContrib += yearContrib;

    let taxAnnual = 0;

    if (taxMode === 'fund') {
      // Fund wrapper: exit tax on dividends + deemed disposal
      let taxDiv = taxBal * netDivY;
      let taxCap = taxBal * netCapGrowth;
      let taxOnDiv = taxDiv * exitTax;
      taxBal += taxDiv - taxOnDiv + taxCap;
      taxAnnual += taxOnDiv;

      // Deemed disposal
      if (y % deemedYrs === 0) {
        let gain = taxBal - taxCostBasis;
        if (gain > 0) {
          let deemedTax = gain * exitTax;
          taxBal -= deemedTax;
          taxAnnual += deemedTax;
          taxCostBasis = taxBal + deemedTax; // reset to market value pre-tax
        }
      }

      // Withdrawal triggers exit tax on gain
      if (wAmt > 0 && taxBal > wAmt) {
        let gainPct = taxCostBasis < taxBal ? (taxBal - taxCostBasis) / taxBal : 0;
        let withdrawGain = wAmt * gainPct;
        let withdrawTax = withdrawGain * exitTax;
        taxBal -= (wAmt + withdrawTax);
        taxAnnual += withdrawTax;
        let proportion = wAmt / (taxBal + wAmt + withdrawTax);
        taxCostBasis *= (1 - proportion);
      }
    } else {
      // Direct equities: income tax on dividends, CGT on realised gains
      let taxDiv = taxBal * netDivY;
      let taxCap = taxBal * netCapGrowth;
      let taxOnDiv = taxDiv * incTax;
      taxBal += taxDiv - taxOnDiv + taxCap;
      taxAnnual += taxOnDiv;

      // No deemed disposal for direct equities — tax on withdrawal/disposal only

      // Withdrawal triggers CGT on gain portion
      if (wAmt > 0 && taxBal > wAmt) {
        let gainPct = taxCostBasis < taxBal ? (taxBal - taxCostBasis) / taxBal : 0;
        let withdrawGain = wAmt * gainPct;
        let taxableGain = Math.max(0, withdrawGain - cgtExempt);
        let withdrawTax = taxableGain * cgtRate;
        taxBal -= (wAmt + withdrawTax);
        taxAnnual += withdrawTax;
        let proportion = wAmt / (taxBal + wAmt + withdrawTax);
        taxCostBasis *= (1 - proportion);
      }
    }

    taxCumTax += taxAnnual;
    taxBalArr.push(taxBal);
    taxCumTaxArr.push(taxCumTax);
    taxAnnTaxArr.push(taxAnnual);
    taxContribArr.push(taxTotalContrib);

    taxGross += yearContrib;
    if (doWithdraw && taxGross > wAmt) taxGross -= wAmt;
    taxGross *= (1 + r);

    // ========== UK ISA ==========
    let isaContrib = Math.min(yearContrib, isaAllow);
    isaBal += isaContrib;
    isaTotalContrib += isaContrib;
    isaBal *= (1 + r);
    if (wAmt > 0 && isaBal > wAmt) isaBal -= wAmt;

    isaBalArr.push(isaBal);
    isaCumTaxArr.push(0);
    isaAnnTaxArr.push(0);
    isaContribArr.push(isaTotalContrib);

    isaGross += isaContrib;
    if (doWithdraw && isaGross > wAmt) isaGross -= wAmt;
    isaGross *= (1 + r);

    // ========== CANADA TFSA ==========
    tfsaUnusedRoom += tfsaAnnualRoom + tfsaRestoredRoom;
    tfsaRestoredRoom = 0;
    let tfsaContrib = Math.min(yearContrib, tfsaUnusedRoom);
    tfsaUnusedRoom -= tfsaContrib;
    tfsaBal += tfsaContrib;
    tfsaTotalContrib += tfsaContrib;
    tfsaBal *= (1 + r);

    let tfsaWithdrawn = 0;
    if (wAmt > 0 && tfsaBal > wAmt) {
      tfsaBal -= wAmt;
      tfsaWithdrawn = wAmt;
    }
    tfsaRestoredRoom = tfsaWithdrawn;

    tfsaBalArr.push(tfsaBal);
    tfsaCumTaxArr.push(0);
    tfsaAnnTaxArr.push(0);
    tfsaContribArr.push(tfsaTotalContrib);

    tfsaGross += tfsaContrib;
    if (doWithdraw && tfsaGross > wAmt) tfsaGross -= wAmt;
    tfsaGross *= (1 + r);

    // ========== SWEDEN ISK ==========
    iskBal += yearContrib;
    iskTotalContrib += yearContrib;
    let iskPostContrib = iskBal;
    iskBal *= (1 + r);
    let iskCloseBal = iskBal;

    // Tax on average of post-contribution and closing balance
    let iskAvgBal = (iskPostContrib + iskCloseBal) / 2;
    let iskAnnualTax = iskAvgBal * iskNotional * iskTaxRate;
    iskBal -= iskAnnualTax;
    iskCumTax += iskAnnualTax;

    if (wAmt > 0 && iskBal > wAmt) iskBal -= wAmt;

    iskBalArr.push(iskBal);
    iskCumTaxArr.push(iskCumTax);
    iskAnnTaxArr.push(iskAnnualTax);
    iskContribArr.push(iskTotalContrib);

    iskGross += yearContrib;
    if (doWithdraw && iskGross > wAmt) iskGross -= wAmt;
    iskGross *= (1 + r);

    // ========== EU PROPOSED ==========
    let euContrib = Math.min(yearContrib, euAllow);
    euBal += euContrib;
    euCostBasis += euContrib;
    euTotalContrib += euContrib;

    let euDiv = euBal * netDivY;
    let euCap = euBal * netCapGrowth;
    let euTaxOnDiv = euDiv * (1 - euExempt) * exitTax;
    euBal += euDiv - euTaxOnDiv + euCap;
    let euAnnTax = euTaxOnDiv;

    // Deemed disposal with partial exemption
    if (y % deemedYrs === 0) {
      let euGain = euBal - euCostBasis;
      if (euGain > 0) {
        let euDeemedTax = euGain * (1 - euExempt) * exitTax;
        euBal -= euDeemedTax;
        euAnnTax += euDeemedTax;
        euCostBasis = euBal + euDeemedTax;
      }
    }

    // Withdrawal triggers partial-exemption exit tax on gain
    if (wAmt > 0 && euBal > wAmt) {
      let gainPct = euCostBasis < euBal ? (euBal - euCostBasis) / euBal : 0;
      let withdrawGain = wAmt * gainPct;
      let withdrawTax = withdrawGain * (1 - euExempt) * exitTax;
      euBal -= (wAmt + withdrawTax);
      euAnnTax += withdrawTax;
      let proportion = wAmt / (euBal + wAmt + withdrawTax);
      euCostBasis *= (1 - proportion);
    }

    euCumTax += euAnnTax;
    euBalArr.push(euBal);
    euCumTaxArr.push(euCumTax);
    euAnnTaxArr.push(euAnnTax);
    euContribArr.push(euTotalContrib);

    euGross += euContrib;
    if (doWithdraw && euGross > wAmt) euGross -= wAmt;
    euGross *= (1 + r);
  }

  // Terminal tax for taxable
  let taxFinalGain = taxBal - taxCostBasis;
  if (taxFinalGain > 0) {
    let finalTax;
    if (taxMode === 'fund') {
      finalTax = taxFinalGain * exitTax;
    } else {
      finalTax = Math.max(0, taxFinalGain - cgtExempt) * cgtRate;
    }
    taxBal -= finalTax;
    taxCumTax += finalTax;
    taxBalArr[horizon - 1] = taxBal;
    taxCumTaxArr[horizon - 1] = taxCumTax;
    taxAnnTaxArr[horizon - 1] += finalTax;
  }

  // Terminal tax for EU
  let euFinalGain = euBal - euCostBasis;
  if (euFinalGain > 0) {
    let euFinalTax = euFinalGain * (1 - euExempt) * exitTax;
    euBal -= euFinalTax;
    euCumTax += euFinalTax;
    euBalArr[horizon - 1] = euBal;
    euCumTaxArr[horizon - 1] = euCumTax;
    euAnnTaxArr[horizon - 1] += euFinalTax;
  }

  // Inflation deflators
  const deflators = [];
  for (let y = 1; y <= horizon; y++) deflators.push(Math.pow(1 + inflationRate, y));
  function deflate(arr) {
    if (!showReal) return arr;
    return arr.map((v, i) => v / deflators[i]);
  }

  const labels = Array.from({length: horizon}, (_, i) => `Year ${i + 1}`);

  const rawAnnTaxArrays = {
    taxable: taxAnnTaxArr,
    isa: isaAnnTaxArr,
    tfsa: tfsaAnnTaxArr,
    isk: iskAnnTaxArr,
    eu: euAnnTaxArr,
  };

  simData = {
    labels, horizon, showReal, rawAnnTaxArrays, inflationRate,
    series: [
      { key: 'taxable', name: 'Taxable (Irish)', color: '#6b7280', dot: 'dot-tax',
        bal: deflate(taxBalArr), cumTax: deflate(taxCumTaxArr), annTax: deflate(taxAnnTaxArr),
        contrib: deflate(taxContribArr),
        totalContrib: taxTotalContrib, grossVal: taxGross,
        rawNetFinal: taxBal, rawTaxFinal: taxCumTax },
      { key: 'isa', name: 'UK ISA', color: '#1e40af', dot: 'dot-uk',
        bal: deflate(isaBalArr), cumTax: deflate(isaCumTaxArr), annTax: deflate(isaAnnTaxArr),
        contrib: deflate(isaContribArr),
        totalContrib: isaTotalContrib, grossVal: isaGross,
        rawNetFinal: isaBal, rawTaxFinal: 0 },
      { key: 'tfsa', name: 'Canada TFSA', color: '#dc2626', dot: 'dot-ca',
        bal: deflate(tfsaBalArr), cumTax: deflate(tfsaCumTaxArr), annTax: deflate(tfsaAnnTaxArr),
        contrib: deflate(tfsaContribArr),
        totalContrib: tfsaTotalContrib, grossVal: tfsaGross,
        rawNetFinal: tfsaBal, rawTaxFinal: 0 },
      { key: 'isk', name: 'Sweden ISK', color: '#f59e0b', dot: 'dot-se',
        bal: deflate(iskBalArr), cumTax: deflate(iskCumTaxArr), annTax: deflate(iskAnnTaxArr),
        contrib: deflate(iskContribArr),
        totalContrib: iskTotalContrib, grossVal: iskGross,
        rawNetFinal: iskBal, rawTaxFinal: iskCumTax },
      { key: 'eu', name: 'EU Proposed', color: '#059669', dot: 'dot-eu',
        bal: deflate(euBalArr), cumTax: deflate(euCumTaxArr), annTax: deflate(euAnnTaxArr),
        contrib: deflate(euContribArr),
        totalContrib: euTotalContrib, grossVal: euGross,
        rawNetFinal: euBal, rawTaxFinal: euCumTax },
    ]
  };

  renderChart();
  renderSummary();
  renderFiscal();
  renderTradeoffs();
}

function renderChart() {
  if (!simData) return;
  const { labels, series, showReal } = simData;
  const realLabel = showReal ? ' (real)' : '';

  let dataKey, yLabel, title;
  if (activeChart === 'wealth') {
    dataKey = 'bal'; yLabel = `Net Value${realLabel} (€)`; title = 'Net portfolio value after all taxes and fees';
  } else if (activeChart === 'tax') {
    dataKey = 'cumTax'; yLabel = `Cumulative Tax${realLabel} (€)`; title = 'Total tax paid over time';
  } else if (activeChart === 'annual') {
    dataKey = 'annTax'; yLabel = `Annual Tax${realLabel} (€)`; title = 'Tax cost each year';
  } else {
    dataKey = 'contrib'; yLabel = `Cumulative Contributions${realLabel} (€)`; title = 'Total contributions into each account (capped by allowance rules)';
  }

  $('chartNote').textContent = title + (showReal ? ' — inflation-adjusted' : ' — nominal');

  const datasets = series.map(s => ({
    label: s.name,
    data: s[dataKey],
    borderColor: s.color,
    backgroundColor: s.color + '18',
    borderWidth: 2,
    pointRadius: 0,
    pointHitRadius: 8,
    tension: 0.3,
    fill: false,
  }));

  if (chart) chart.destroy();
  chart = new Chart($('mainChart'), {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        tooltip: {
          callbacks: {
            label: ctx => `${ctx.dataset.label}: €${Math.round(ctx.parsed.y).toLocaleString()}`
          }
        },
        legend: { position: 'top', labels: { usePointStyle: true, pointStyle: 'circle', padding: 16, font: { size: 12 } } }
      },
      scales: {
        y: {
          ticks: { callback: v => '€' + (v >= 1e6 ? (v/1e6).toFixed(1) + 'M' : v >= 1e3 ? (v/1e3).toFixed(0) + 'k' : v) },
          title: { display: true, text: yLabel }
        },
        x: { ticks: { maxTicksLimit: 15 }, title: { display: true, text: 'Year' } }
      }
    }
  });
}

function renderSummary() {
  const { series, horizon, showReal } = simData;
  const deflator = showReal ? Math.pow(1 + val('inflation') / 100, horizon) : 1;
  $('summaryTitle').textContent = `Summary at End of Horizon${showReal ? ' (real terms)' : ''}`;

  const taxableNet = series[0].bal[horizon - 1];
  $('summaryTable').querySelector('tbody').innerHTML = series.map(s => {
    const net = s.bal[horizon - 1];
    const tax = s.cumTax[horizon - 1];
    const contrib = s.contrib[horizon - 1];
    const gross = s.grossVal / deflator;
    const grossGain = gross - contrib;
    const effRate = grossGain > 0 ? tax / grossGain : 0;
    const advantage = net - taxableNet;
    return `<tr>
      <td><span class="dot ${s.dot}"></span>${s.name}</td>
      <td>${fmt(contrib)}</td>
      <td>${fmt(gross)}</td>
      <td>${fmt(tax)}</td>
      <td><strong>${fmt(net)}</strong></td>
      <td>${pct(effRate)}</td>
      <td style="color:${advantage >= 0 ? '#059669' : '#dc2626'}">${advantage >= 0 ? '+' : ''}${fmt(advantage)}</td>
    </tr>`;
  }).join('');
}

function renderFiscal() {
  const { series, horizon, showReal, rawAnnTaxArrays, inflationRate } = simData;
  const deflator = showReal ? Math.pow(1 + inflationRate, horizon) : 1;
  const stateRate = val('stateRate') / 100;
  const popAccounts = val('popAccounts');
  const pensionOffsetPct = val('pensionOffset') / 100;
  const pensionCost = val('pensionCost');
  const pensionYears = val('pensionYears');
  const retireAge = val('retireAge');
  const startAge = val('startAge');
  const gdpGrowth = val('gdpGrowth') / 100;

  const taxableAnnTax = rawAnnTaxArrays.taxable;

  // Revenue benchmarks (2024 base)
  const CGT_2024 = 2.2e9;
  const INC_2024 = 32e9;
  const TOT_2024 = 90e9;
  const SPC_2024 = 9.5e9;

  function computeNPV(stream) {
    let npv = 0;
    for (let y = 0; y < stream.length; y++) npv += stream[y] / Math.pow(1 + stateRate, y + 1);
    return npv;
  }

  // Pension offset: NPV of saved pension, starting at retirement age (not end of horizon)
  // Offset scaled by each account's net wealth relative to taxable baseline
  const pensionStartYear = Math.max(horizon, retireAge - startAge);
  function computePensionOffsetPV() {
    let pv = 0;
    for (let y = 0; y < pensionYears; y++) {
      pv += pensionCost / Math.pow(1 + stateRate, pensionStartYear + y + 1);
    }
    return pv * pensionOffsetPct;
  }
  const basePensionPV = computePensionOffsetPV(); // per account at 100% offset scale

  // Net wealth of taxable baseline for scaling pension offset
  const taxableNetWealth = series[0].rawNetFinal;

  const accountKeys = ['isa', 'tfsa', 'isk', 'eu'];
  const fiscalData = series.slice(1).map((s, idx) => {
    const key = accountKeys[idx];
    const annTaxArr = rawAnnTaxArrays[key];

    const annForegone = taxableAnnTax.map((t, i) => t - annTaxArr[i]);
    const totalForegone = annForegone.reduce((a, b) => a + b, 0);
    const npvForegone = computeNPV(annForegone);
    const annualised = totalForegone / horizon;
    const year1Cost = annForegone[0] || 0;
    const finalYearCost = annForegone[horizon - 1] || 0;

    const displayForegone = showReal ? totalForegone / deflator : totalForegone;
    const displayNPV = npvForegone;
    const displayAnnualised = showReal ? annualised / deflator : annualised;

    const gross = s.grossVal / deflator;

    // Pension offset scaled by relative wealth improvement
    const wealthRatio = taxableNetWealth > 0 ? s.rawNetFinal / taxableNetWealth : 1;
    const pensionOffsetThisAccount = basePensionPV * wealthRatio;

    return {
      series: s,
      totalForegone: displayForegone,
      npvForegone: displayNPV,
      pctGross: gross > 0 ? displayForegone / gross : 0,
      annualised: displayAnnualised,
      rawTotalForegone: totalForegone,
      rawNPV: npvForegone,
      rawAnnualised: annualised,
      rawYear1: year1Cost,
      rawFinalYear: finalYearCost,
      pensionOffsetPV: pensionOffsetThisAccount,
    };
  });

  // --- Per Investor Table ---
  $('fiscalTable').querySelector('tbody').innerHTML = fiscalData.map(d => {
    const isNeg = d.totalForegone < 0;
    const label = isNeg ? 'Revenue gain' : 'Tax foregone';
    return `<tr>
      <td><span class="dot ${d.series.dot}"></span>${d.series.name}</td>
      <td style="color:${isNeg ? '#059669' : ''}">${fmt(d.totalForegone)}</td>
      <td style="color:${d.npvForegone < 0 ? '#059669' : ''}">${fmt(d.npvForegone)}</td>
      <td>${pct(d.pctGross)}</td>
      <td>${fmt(d.annualised)}/yr</td>
    </tr>`;
  }).join('');

  // --- Aggregate National Table ---
  $('popLabel').textContent = popAccounts.toLocaleString();

  $('aggFiscalTable').querySelector('tbody').innerHTML = fiscalData.map(d => {
    const aggNPV = d.rawNPV * popAccounts;
    const aggAnnual = d.rawAnnualised * popAccounts;
    const aggYear1 = d.rawYear1 * popAccounts;
    const aggFinal = d.rawFinalYear * popAccounts;
    const aggPension = d.pensionOffsetPV * popAccounts;
    const netCost = aggNPV - aggPension;
    const showPension = pensionOffsetPct > 0;
    return `<tr>
      <td><span class="dot ${d.series.dot}"></span>${d.series.name}</td>
      <td style="color:${aggNPV < 0 ? '#059669' : ''}">${fmtBn(aggNPV)}</td>
      <td>${fmtBn(aggAnnual)}/yr</td>
      <td>${fmtBn(aggYear1)}</td>
      <td>${fmtBn(aggFinal)}</td>
      <td style="color:${showPension ? '#059669' : 'var(--muted)'}">${showPension ? fmtBn(-aggPension) : '—'}</td>
      <td style="color:${netCost > 0 ? '#dc2626' : '#059669'}"><strong>${fmtBn(netCost)}</strong></td>
    </tr>`;
  }).join('');

  // --- Comparison Anchors Table ---
  // Show year-1 vs 2024 benchmarks AND final-year vs projected benchmarks
  const growFactor = Math.pow(1 + gdpGrowth, horizon);
  const CGT_final = CGT_2024 * growFactor;
  const INC_final = INC_2024 * growFactor;
  const TOT_final = TOT_2024 * growFactor;
  const SPC_final = SPC_2024 * growFactor;

  $('anchorTable').querySelector('tbody').innerHTML = fiscalData.flatMap(d => {
    const aggYear1 = d.rawYear1 * popAccounts;
    const aggFinal = d.rawFinalYear * popAccounts;
    return [
      `<tr>
        <td rowspan="2"><span class="dot ${d.series.dot}"></span>${d.series.name}</td>
        <td>Year 1</td>
        <td>${fmtBn(aggYear1)}</td>
        <td>${pct(aggYear1 / CGT_2024)}</td>
        <td>${pct(aggYear1 / INC_2024)}</td>
        <td>${pct(aggYear1 / TOT_2024)}</td>
        <td>${pct(aggYear1 / SPC_2024)}</td>
      </tr>`,
      `<tr>
        <td>Year ${horizon}</td>
        <td>${fmtBn(aggFinal)}</td>
        <td>${pct(aggFinal / CGT_final)}</td>
        <td>${pct(aggFinal / INC_final)}</td>
        <td>${pct(aggFinal / TOT_final)}</td>
        <td>${pct(aggFinal / SPC_final)}</td>
      </tr>`
    ];
  }).join('');
}

function renderTradeoffs() {
  const { series, horizon, showReal } = simData;
  const taxableNet = series[0].bal[horizon - 1];
  const best = series.reduce((a, b) => b.bal[horizon-1] > a.bal[horizon-1] ? b : a);
  const iskTax = series[3].cumTax[horizon - 1];
  const taxableTax = series[0].cumTax[horizon - 1];
  const termsLabel = showReal ? ' (real terms)' : '';
  const taxMode = getTaxMode();

  const r = val('annualReturn');
  const feeVal = val('fee');
  const iskRate = val('iskRate');
  const iskEffective = (iskRate * val('iskTaxRate') / 100);
  const withdrawAmt = val('withdraw');

  let html = `<p><strong>Best outcome for the investor${termsLabel}:</strong> ${best.name} produces the highest net wealth of ${fmt(best.bal[horizon-1])}.</p>`;

  html += `<p><strong>Taxable baseline:</strong> Modelled as ${taxMode === 'fund' ? 'an Irish fund wrapper (41% exit tax, ' + val('deemedYrs') + '-year deemed disposal)' : 'direct equities (' + val('incTax') + '% on dividends, ' + val('cgt') + '% CGT, €' + val('cgtExempt').toLocaleString() + ' annual exemption)'}.</p>`;

  if (feeVal > 0) {
    html += `<p><strong>Fee drag:</strong> At ${feeVal}% annual fees, the cumulative cost over ${horizon} years is substantial. Fees reduce both dividend and capital growth proportionally.</p>`;
  }

  html += `<p><strong>ISK fairness note:</strong> The ISK levies tax even when actual returns are below the notional rate (${iskRate}%). `;
  const netR = r - feeVal;
  if (netR > iskRate) {
    html += `At ${netR.toFixed(1)}% net return vs ${iskRate}% notional, the ISK is favourable — effective annual drag is ~${iskEffective.toFixed(2)}%.</p>`;
  } else {
    html += `At ${netR.toFixed(1)}% net return vs ${iskRate}% notional, the investor is <em>overtaxed</em> relative to actual gains.`;
    if (iskTax > taxableTax) {
      html += ` <strong>The ISK actually raises more revenue than the taxable baseline in this scenario</strong> — it is a revenue-positive reform, not a fiscal cost.`;
    }
    html += `</p>`;
  }

  html += `<p><strong>Exchequer perspective:</strong> `;
  const isaForegone = taxableTax - series[1].cumTax[horizon-1];
  const tfsaForegone = taxableTax - series[2].cumTax[horizon-1];
  const iskForegone = taxableTax - iskTax;
  if (iskForegone < 0) {
    html += `The ISA and TFSA cost the state ${fmt(isaForegone)} and ${fmt(tfsaForegone)} in foregone revenue respectively. The ISK <em>raises</em> ${fmt(-iskForegone)} more than the taxable baseline, making it revenue-positive under these assumptions.</p>`;
  } else {
    html += `The ISA and TFSA cost the state the most (${fmt(isaForegone)} and ${fmt(tfsaForegone)}). The ISK maintains steady revenue (${fmt(iskTax)} total).</p>`;
  }

  html += `<p><strong>Distributional concern:</strong> At €${val('contrib').toLocaleString()}/yr starting contribution, the ISA and TFSA disproportionately benefit higher-income households. The ISK's unlimited contributions but steady tax drag partially mitigate this.</p>`;

  if (withdrawAmt > 0) {
    html += `<p><strong>Withdrawal dynamics:</strong> With €${withdrawAmt.toLocaleString()}/yr withdrawals from year ${val('withdrawStart')}: TFSA restores room next year; ISA is flexible; taxable and EU accounts trigger tax on the embedded gain in withdrawn units.</p>`;
  }

  const endAge = val('startAge') + horizon;
  html += `<p><strong>Lifetime framing:</strong> Age ${val('startAge')} to ${endAge} (${horizon} years). `;
  if (val('startAge') === 0) {
    html += `A birth-to-${endAge} account with TFSA-style carry-forward accumulates unused room during childhood, creating a powerful catch-up mechanism when earnings begin.</p>`;
  } else {
    html += `A birth-to-death account with TFSA-style carry-forward would accumulate substantial unused room in early years.</p>`;
  }

  if (showReal) {
    html += `<p><strong>Real terms:</strong> All figures deflated by ${val('inflation')}% inflation. Nominal balances would be ${pct(Math.pow(1 + val('inflation')/100, horizon) - 1)} higher.</p>`;
  }

  $('tradeoffs').innerHTML = html;
}

// --- Init ---
loadFromHash();
runSim();
</script>
</body>
</html>
